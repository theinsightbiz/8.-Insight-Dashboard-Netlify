<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CA Task & Billing Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
  <!-- html2canvas + jsPDF for client-side PDF export -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('html2canvas load failed')"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('jsPDF load failed')"></script>

  <!-- ‚úÖ pdf.js (ESM) with dual-CDN fallback; exposes window.pdfjsLib and sets worker -->
  <script type="module">
    (async () => {
      async function tryImport(from, ver="4.6.82") {
        const base = `${from}/pdfjs-dist@${ver}/build`;
        const pdf = await import(`${base}/pdf.min.mjs`);
        // Expose globally for script.js
        window.pdfjsLib = pdf;
        // Worker must also be an ESM file
        pdf.GlobalWorkerOptions.workerSrc = `${base}/pdf.worker.min.mjs`;
        window.__pdfWorkerSet = true;
      }
      try {
        await tryImport("https://unpkg.com");
      } catch (e1) {
        (window.__libErr = (window.__libErr||[])).push('pdf.js import failed (unpkg): ' + (e1 && e1.message));
        try {
          await tryImport("https://cdn.jsdelivr.net/npm");
        } catch (e2) {
          (window.__libErr = (window.__libErr||[])).push('pdf.js import failed (jsDelivr): ' + (e2 && e2.message));
          window.__pdfWorkerSet = false;
        }
      }
    })();
  </script>

  <!-- Tesseract.js for OCR fallback on image-only PDFs -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('tesseract.js load failed')"></script>
</head>
<body>
  <div class="container" id="appRoot">
    <header>
      <div class="title">
        <img src="logo.png" alt="Firm Logo" class="logo" />
        <span class="pill">Tasks ‚Ä¢ Deadlines ‚Ä¢ Billing</span>
      </div>
      <div class="actions">
        <button class="btn icon primary" id="addTaskBtn" aria-haspopup="dialog">‚ûï Add Task</button>
        <button class="btn icon" id="createInvoiceBtn" aria-haspopup="dialog">üßæ Create Invoice</button>
        <button class="btn icon ghost" id="bulkDeleteBtn" title="Delete selected">üóëÔ∏è Bulk Delete</button>
        <button class="btn icon ghost" id="exportCsvBtn">‚¨áÔ∏è Export CSV</button>
      </div>
    </header>

    <!-- Filters / Controls -->
    <div class="controls" role="region" aria-label="Filters">
      <div class="field"><input class="input" id="searchInput" placeholder="Search client, task, assignee‚Ä¶" aria-label="Search" /></div>
      <div class="field">
        <select class="select" id="priorityFilter" aria-label="Priority filter">
          <option value="">Priority: All</option>
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </div>
            <!-- Replace the old <select id="statusFilter">...</select> with this -->
<div class="field">
  <!-- hidden input keeps compatibility with existing JS -->
  <input type="hidden" id="statusFilter" value="">
  <div class="multi" id="statusMulti">
    <button type="button" class="btn icon" id="statusMultiBtn">Status: All</button>
    <div class="menu" id="statusMultiMenu" hidden>
      <label><input type="checkbox" value="Not Started"> Not Started</label>
      <label><input type="checkbox" value="In Progress"> In Progress</label>
      <label><input type="checkbox" value="Waiting Client"> Waiting Client</label>
      <label><input type="checkbox" value="On Hold"> On Hold</label>
      <label><input type="checkbox" value="Completed"> Completed</label>
      <div class="menu-actions">
        <button type="button" class="btn ghost" id="statusClearBtn">Clear</button>
        <button type="button" class="btn primary" id="statusApplyBtn">Done</button>
      </div>
    </div>
  </div>
</div>
      <div class="field">
        <select class="select" id="assigneeFilter" aria-label="Assignee filter">
          <option value="">In-Charge: All</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="monthFilter" aria-label="Month filter">
          <option value="">Month: All</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="sortBy" aria-label="Sort by">
          <option value="deadline">Sort: Deadline</option>
          <option value="createdAt">Sort: Created</option>
          <option value="priority">Sort: Priority</option>
          <option value="status">Sort: Status</option>
          <option value="fee">Sort: Fee</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="sortDir" aria-label="Sort direction">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
      </div>
    </div>

    <!-- Summary Cards -->
    <section class="grid" aria-label="Summary">
      <div class="card"><h3>Total Tasks</h3><div class="val" id="kpiTotal">0</div></div>
      <div class="card"><h3>Pending</h3><div class="val" id="kpiPending">0</div></div>
      <div class="card"><h3>Overdue</h3><div class="val" id="kpiOverdue">0</div></div>
      <div class="card"><h3>Fee (‚Çπ)</h3><div class="val money" id="kpiFee">0</div></div>
      <div class="card"><h3>Received (‚Çπ)</h3><div class="val money" id="kpiAdv">0</div></div>
      <div class="card"><h3>Outstanding (‚Çπ)</h3><div class="val money" id="kpiOut">0</div></div>
    </section>

    <!-- Table -->
    <table class="table" aria-label="Tasks table">
      <colgroup>
        <col class="col-check">
        <col class="col-client">
        <col class="col-task">
        <col class="col-pri">
        <col class="col-assignee">
        <col class="col-status">
        <col class="col-deadline">
        <col class="col-money">
        <col class="col-money">
        <col class="col-money">
        <col class="col-invoice">
        <col class="col-actions">
      </colgroup>
      <thead class="thead">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Client</th>
          <th>Task</th>
          <th>Priority</th>
          <th>In-Charge</th>
          <th>Status</th>
          <th>Deadline</th>
          <th>Fee</th>
          <th>Received</th>
          <th>Outstanding</th>
          <th>Invoice Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="taskTbody"></tbody>
    </table>

    <footer class="note">Insight at work: organize, analyze, achieve.</footer>
  </div>

  <!-- Modal: Add/Edit Task -->
  <div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
    <div class="dialog">
      <header>
        <h2 id="taskModalTitle">New Task</h2>
      </header>
      <form id="taskForm">
        <div class="body">
          <div class="dialog grid2">
            <div>
  <label>Client Name</label>
  <select id="fClientSelect" class="select" aria-label="Client (existing)">
    <option value="">Select Client</option>
  </select>
  <!-- Shown only when "New client‚Ä¶" is selected -->
  <input id="fClientNew" placeholder="Enter new client" style="display:none;margin-top:6px;" />
  <!-- Hidden value used for form submission compatibility -->
  <input id="fClient" type="hidden" />
  <small class="hint">Pick an existing client, or choose ‚ÄúNew client‚Ä¶‚Äù to type a fresh one.</small>
</div>
            <div>
              <label>Task Title</label>
              <select id="fTitleSelect" class="select" aria-label="Task Title (existing)">
                <option value="">Select Title</option>
              </select>
              <!-- Shown only when "New title‚Ä¶" is selected -->
              <input id="fTitleNew" placeholder="Enter new title" style="display:none;margin-top:6px;" />
              <!-- Hidden value used for form submission compatibility -->
              <input id="fTitle" type="hidden" />
              <small class="hint">Pick an existing title, or choose ‚ÄúNew title‚Ä¶‚Äù to type a fresh one.</small>
            </div>
            <div>
              <label>Priority</label>
              <select id="fPriority" required>
                <option>High</option>
                <option selected>Medium</option>
                <option>Low</option>
              </select>
            </div>
            <div>
              <label>In‚ÄëCharge</label>
              <input required id="fAssignee" placeholder="Team member" />
            </div>
            <div>
              <label>Status</label>
              <select id="fStatus" required>
                <option>Not Started</option>
                <option selected>In Progress</option>
                <option>Waiting Client</option>
                <option>On Hold</option>
                <option>Completed</option>
              </select>
            </div>
            <div>
              <label>Deadline</label>
              <input type="date" id="fDeadline" required />
            </div>
            <div>
              <label>Fee (‚Çπ)</label>
              <input type="number" step="0.01" min="0" id="fFee" required />
            </div>
            <div>
              <label>Received (‚Çπ)</label>
              <input type="number" step="0.01" min="0" id="fAdvance" value="0" />
            </div>
            <div>
              <label>Invoice Status</label>
  <select id="fInvoiceStatus">
    <option value="">Select status‚Ä¶</option>
    <option>Not Raised</option>
    <option>Sent</option>
    <option>Paid</option>
    <option>Partially Paid</option>
  </select>
</div>
            <div>
              <label>Notes / Description</label>
              <textarea id="fNotes" placeholder="Brief details, documents pending, etc."></textarea>
            </div>
            <div>
              <label><input type="checkbox" id="fRecurring" /> Recurring monthly</label> <label style="margin-left:16px;"><input type="checkbox" id="fRecurringQ" /> Recurring quarterly</label>
              <small class="hint">If checked, this becomes a template. The app will auto‚Äëcreate instances (monthly or quarterly) on the same day as the deadline.</small>
            </div>
          </div>
        </div>
        <footer>
          <button type="button" class="btn ghost" id="cancelBtn">Cancel</button>
          <button class="btn primary" type="submit" id="saveBtn">Save Task</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- Modal: Create Invoice -->
  <div class="modal" id="invoiceModal" role="dialog" aria-modal="true" aria-labelledby="invoiceModalTitle">
    <div class="dialog">
      <header><h2 id="invoiceModalTitle">Create Invoice</h2></header>
      <form id="invoiceForm">
        <div class="body">
          <div class="dialog grid2">
            <div><label>Invoice No.</label><input id="invNumber" required /></div>
            <div><label>Invoice Date</label><input type="date" id="invDate" required /></div>
            <div><label>Client Name</label><input id="invClient" required placeholder="Billed to / Receiver" /></div>
            <div><label>Mobile No.</label><input id="invMobile" placeholder="+91‚Ä¶" /></div>
            <div><label>Email</label><input id="invEmail" type="email" placeholder="client@example.com" /></div>
            <div><label>Address</label><textarea id="invAddress" placeholder="Street, City, State, PIN"></textarea></div>
          </div>

          <div class="inv-services">
            <div class="inv-services-head">
              <h3>Service Lines</h3>
              <div class="row-actions">
                <button type="button" class="btn" id="addServiceRowBtn">‚ûï Add Row</button>
                <button type="button" class="btn ghost" id="openEditInvoiceBtn" title="Upload an existing invoice PDF to edit">üñäÔ∏è Edit from PDF</button>
              </div>
            </div>
            <div class="inv-grid-head">
              <span>#</span><span>Description of Service</span><span class="money">Amount (‚Çπ)</span><span>‚Äî</span>
            </div>
            <div id="serviceRows"></div>
            <div class="inv-totals">
              <div class="tot-row"><span>Sub Total</span><span class="money">‚Çπ <span id="subTotal">0</span></span></div>
              <div class="tot-row"><label for="discountInput">Less: Advance</label><input id="discountInput" type="number" min="0" step="0.01" value="0"></div>
              <div class="tot-row strong"><span>Invoice Amount</span><span class="money">‚Çπ <span id="grandTotal">0</span></span></div>
              <div class="tot-row words"><small>Amount (in words): <span id="amountWords">Zero Rupees only</span></small></div>
            </div>
          </div>

        <footer>
          <button type="button" class="btn ghost" id="invoiceCancelBtn">Cancel</button>
          <button type="button" class="btn" id="previewInvoiceBtn">Preview</button>
          <button type="button" class="btn primary" id="downloadPdfBtn">Download PDF</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Invoice (Upload PD) -->
  <div class="modal" id="editInvoiceModal" role="dialog" aria-modal="true" aria-labelledby="editInvoiceTitle">
  <div class="dialog">
    <header>
      <h2 id="editInvoiceTitle">Edit Invoice ‚Äì Upload Existing PDF</h2>
    </header>
    <div class="body">
      <div class="edit-grid">
        <div class="uploader" id="pdfDrop">
          <input type="file" id="pdfInput" accept="application/pdf" />
          <p><strong>Drop your invoice PDF here</strong> or click to select.</p>
          <small>Tip: Use an invoice previously downloaded from this app for best results.</small>
        </div>

        <!-- ‚úÖ Debug info section placed right after uploader -->
        <div id="parseLog" class="parse-log" aria-live="polite"></div>
        <details style="margin-top:8px;">
          <summary>üîç Debug Log</summary>
          <pre id="debugInfo" style="background:#f9f9f9; padding:8px; border:1px solid #ddd; max-height:200px; overflow:auto;"></pre>
        </details>
        <!-- ‚úÖ End Debug info -->
      </div>
    </div>
    <footer>
      <button type="button" class="btn ghost" id="editCancelBtn">Close</button>
    </footer>
  </div>
</div>



  <!-- Hidden A4 Invoice Template (render target for PDF) -->
  <div id="invoiceA4" aria-hidden="true">
    <div class="a4 page">
      <div class="inv-letterhead">
        <div class="lh-left">
          <img src="logo.png" alt="Firm Logo">
          <div class="lh-firm">
            <div class="firm-name">INSIGHT BUSINESS CONSULTANCY</div>
            <div class="firm-sub">A-272, Block A, Surajmal Vihar, New Delhi- 110092</div>
            <div class="firm-sub">Mobile: 9953921244 ‚Ä¢ E-mail: contact@theinsightbiz.com</div>
            <div class="firm-sub">PAN: AAKFI9556M</div>
          </div>
        </div>
        <div class="lh-right">
          <div class="tax-invoice">TAX INVOICE</div>
          <div class="inv-meta">
            <div><strong>Invoice No:</strong> <span data-bind="invNumber"></span></div>
            <div><strong>Invoice Date:</strong> <span data-bind="invDateDDMM"></span></div>
          </div>
        </div>
      </div>

      <div class="inv-billto">
        <div class="box-title">ORIGINAL FOR RECIPIENT</div>
        <div class="bt-grid">
          <div><strong>Detail of Receiver (Billed to Party)</strong></div>
          <div><strong>Invoice Amount</strong></div>
          <div>
            <div><strong>Name:</strong> <span data-bind="client"></span></div>
            <div><strong>Address:</strong> <span data-bind="address"></span></div>
            <div><strong>E-mail:</strong> <span data-bind="email"></span></div>
            <div><strong>Mobile No:</strong> <span data-bind="mobile"></span></div>
          </div>
          <div class="money big">‚Çπ <span data-bind="grandTotal"></span></div>
        </div>
      </div>

      <table class="inv-table">
        <thead>
          <tr><th style="width:40px">S. No.</th><th>Service Description</th><th style="width:160px" class="money">Amount (‚Çπ)</th></tr>
        </thead>
        <tbody data-bind="rows"></tbody>
        <tfoot>
          <tr><th colspan="2" class="right">Sub Total</th><th class="money">‚Çπ <span data-bind="subTotal"></span></th></tr>
          <tr><th colspan="2" class="right">Less: Advance</th><th class="money">‚Çπ <span data-bind="discount"></span></th></tr>
          <tr class="total"><th colspan="2" class="right">Invoice Amount</th><th class="money">‚Çπ <span data-bind="grandTotal"></span></th></tr>
          <tr><td colspan="3" class="words">Invoice Amount (in words): <strong><span data-bind="amountWords"></span></strong></td></tr>
        </tfoot>
      </table>

      <div class="inv-banking">
        <div class="box-title">Banking Details</div>
        <div class="bank-grid">
          <div><strong>Account Holder Name:</strong> Insight Business Consultancy</div>
          <div><strong>Bank Name:</strong> IDFC First Bank</div>
          <div><strong>Bank A/c:</strong> 101 9939 2303</div>
          <div><strong>Bank IFSC:</strong> IDFB 0021 416</div>
        </div>
      </div>

      <div class="inv-terms">
        <div class="box-title">Terms &amp; Conditions</div>
        <ol>
          <li>Amounts must be paid within 03 days.</li>
          <li>May deduct TDS @ 10% as per IT Act u/s 194J.</li>
          <li>E &amp; O Expected.</li>
        </ol>
      </div>
      <div class="inv-note">Note: This is a computer generated invoice and hence does not require a signature.</div>

      <div class="inv-sign">
        <div class="sign-name">Priyam Adarsh</div>
        <div class="sign-title">Partner/ Authorised Signatory</div>
      </div>
    </div>
  </div>

  <!-- Only addition: Firebase compat SDK before your original script -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <!-- Your existing app code below (unchanged references) -->
  <script src="script.js"></script>
</body>
</html>